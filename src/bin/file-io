#!/usr/bin/env bash

file_io_help ( )
{
	echo "file-io usage:"
		echo "  help                            This menu"
	echo "  disable <instance>              Disable all configs for <instance>"
	echo "  disable <instance> <config>     Disable <config> for <instance>"
	echo "  enable <instance>               Enable all configs for <instance>"
	echo "  enable <instance> <config>      Enable <config> for <instance>"
	echo "  list                            Show all the file-io configurations for each instance"
        exit
}

cmd_help ( )
{
	file_io_help
}

disable_config ( )
{
	local conf_name=$1
	local file_io_config=$2

	if ! test -f $file_io_config
	then
		printf "config [$conf_name] not enabled\n"
		return
	fi

	rm -f $file_io_config
	printf "config [$conf_name] disabled\n"
}

enable_config ( )
{
	local conf_name=$1
	local instance_config=$2
	local file_io_config=$3

	if test -f $file_io_config
	then
		printf "config [$conf_name] already enabled\n"
		return
	fi

	ln -s $instance_config $file_io_config
	printf "config [$conf_name] enabled\n"
}

cmd_disable ( )
{
	local instance_name=$2
	local config_name=$3
	local instance_dir=
	local current_instance=$PQ_CURRENT_INSTANCE

	local location=
	local entity=
	local part=
	local instance=

	dir=$PQ_CHASSIS_VAR_DIR/$( echo $current_instance | awk -F '/' '{ print "/installations/entities/" $1 "/location/" $2 "/parts/" $3 "/instances/" $4 }' )

	if test -z "$instance_name"
	then
		printf "No instance specified\n"
		exit 1
	fi

	entity=$( echo $instance_name | awk -F'/' '{ print $1 }' )
	location=$( echo $instance_name | awk -F'/' '{ print $2 }' )
	part=$( echo $instance_name | awk -F'/' '{ print $3 }' )
	instance=$( echo $instance_name | awk -F'/' '{ print $4 }' )
	
	if test -z "$location" || test -z "$entity" || test -z "$part" || test -z "$instance"
	then
		printf "Instance name was not in the correct format location/entity/part/instance\n"
		exit 1
	fi

	instance_dir=$PQ_CHASSIS_VAR_DIR/installations/entities/$entity/location/$location/parts/$part/instances/$instance/

	if test -z "$config_name"
	then
		local confs=$( find $instance_dir/file-io -type f -name "*.file-io" -printf "%f\n" 2>/dev/null )
		for i in $confs
		do
			disable_config "$i" "$dir/conf/$entity-$location-$part-$instance-$i"
		done
		
	else
		disable_config "$config_name" "$dir/conf/$entity-$location-$part-$instance-$config_name"
	fi
}

cmd_enable ( )
{
	local instance_name=$2
	local config_name=$3
	local instance_dir=
	local current_instance=$PQ_CURRENT_INSTANCE

	local location=
	local entity=
	local part=
	local instance=

	dir=$PQ_CHASSIS_VAR_DIR/$( echo $current_instance | awk -F '/' '{ print "/installations/entities/" $1 "/location/" $2 "/parts/" $3 "/instances/" $4 }' )

	if test -z "$instance_name"
	then
		printf "No instance specified\n"
		exit 1
	fi

	entity=$( echo $instance_name | awk -F'/' '{ print $1 }' )
	location=$( echo $instance_name | awk -F'/' '{ print $2 }' )
	part=$( echo $instance_name | awk -F'/' '{ print $3 }' )
	instance=$( echo $instance_name | awk -F'/' '{ print $4 }' )
	
	if test -z "$location" || test -z "$entity" || test -z "$part" || test -z "$instance"
	then
		printf "Instance name was not in the correct format location/entity/part/instance\n"
		exit 1
	fi

	instance_dir=$PQ_CHASSIS_VAR_DIR/installations/entities/$entity/location/$location/parts/$part/instances/$instance/

	if test -z "$config_name"
	then
		local confs=$( find $instance_dir/file-io -type f -name "*.file-io" -printf "%f\n" 2>/dev/null )
		for i in $confs
		do
			enable_config "$i" "$instance_dir/file-io/$i" "$dir/conf/$entity-$location-$part-$instance-$i"
		done
		
	else
		enable_config "$config_name" "$instance_dir/file-io/$config_name" "$dir/conf/$entity-$location-$part-$instance-$config_name"
	fi
}

cmd_list ( )
{
	local configs=$( find $PQ_CHASSIS_VAR_DIR/installations/ -type f -name "*.file-io" 2>/dev/null | grep "file-io\/[^/]*.file-io$" )
	local conf=
	local instance=
	local name=
	local file=
	local instance_dir=
	local dir=
	local enabled=

	instance_dir=$( echo $PQ_CURRENT_INSTANCE | awk -F '/' '{ print "/installations/entities/" $1 "/location/" $2 "/parts/" $3 "/instances/" $4 }' )
	dir=$PQ_CHASSIS_VAR_DIR/$instance_dir/

	printf "File-IO:\n\n"
	printf "  %-30s %-30s %-20s\n" "instance" "config" "status"
	for i in $configs
	do
		conf=$( echo $i | awk -F '/' '{ print $9 "/" $11 "/" $13 "/" $15 " " $17 }' )
		instance=$( echo $conf | awk '{ print $1 }' )
		name=$( echo $conf | awk '{ print $2 }' )		

		file=$dir/conf/${instance//\//-}-$name
		if test -f $file
		then
			enabled="enabled"
		else
			enabled=""
		fi

		printf "  %-30s %-30s %-20s\n" "$instance" "$name" "$enabled"
	done
}

command=

if test -z "$PQ_CURRENT_INSTANCE"
then
	printf "No instance currently selected\n"
	exit 1
fi

while test $# != 0 && test -z "$command"
do
	case "$1" in
		help | list | enable | disable )
			command=$1
			;;
		* )
			break
			;;
	esac
done

if test -z "$command"
then
	command=help
fi

"cmd_$command" "$@"
